#!/bin/bash

# Copy this file to .git/hooks to enable this post-receive hook

project_name='admin-server'
deploy_dir='/home/pi/deploy/admin-server'
repo_dir='/home/pi/repos/admin-server.git'
server_port=18000

while read oldrev newrev ref
do
    if [[ $ref =~ .*/master$ ]];
    then
        echo "=> Deploying master branch..."
		git --work-tree=$deploy_dir --git-dir=$repo_dir checkout -f

        echo
		container_id=$(docker ps --filter name=$project_name --format '{{.ID}}');
        if [ -z $container_id ];
        then
            echo "=> No running container detected";
        else
            echo "=> Stopping running container (id: $container_id)...";
        	docker stop $container_id;
        fi

        echo
		echo "=> Building master branch..."
		docker image build -t $project_name':latest' $deploy_dir \
		    && echo && echo "=> Starting new container on port $server_port..." \
            && docker run -p$server_port:$server_port \
                      -e SERVER_PORT=$server_port \
                      -d --rm --name $project_name $project_name':latest'

        echo
        echo "=> Cleaning up...";
        docker container prune -f \
            && docker image prune -f

        echo
        echo "=> Current resource usage:";
        docker system df

        echo
		echo "=> Done"
    else
        echo "Ref $ref received successfully. Doing nothing: only the master branch will be deployed on this server."
    fi
done
